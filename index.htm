<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Orbiter Update Installer</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        integrity="sha512-g9C6d0AqR7XzQ8Sh..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="style.css">

  <script type="module" src="https://unpkg.com/esp-web-tools@10.1.0/dist/web/install-button.js?module"></script>
</head>

<body onload="initInstaller()">

  <div id="unsupported" class="card" hidden>
    <h2>Browser Not Supported</h2>
    <p>Please use Chrome or Edge on desktop.</p>
    <div class="browser-buttons">
      <button onclick="window.open('microsoft-edge:', '_blank')">Open Edge</button>
      <button onclick="window.open('https://www.google.com/chrome/', '_blank')">Download Chrome</button>
    </div>
  </div>

  <div id="installer" class="card" hidden>
    <img src="arsenal-logo.png" alt="Arsenal51 Logo" class="logo">

    <h1>UPDATE YOUR ORBITER</h1>
    <p class="subtitle">Flash firmware to your Orbiter</p>

    <div class="github-download">
      <p>Download firmware `.bin` files (optional):</p>
      <a href="https://github.com/arsenal51/WLED-Arsenal51/releases" target="_blank">
        View GitHub Releases
      </a>
    </div>

    <div class="steps">
      <div>1. Plug in your Orbiter device</div>
      <div>2. Select firmware file (.bin)</div>
      <span class="version-warning">
        * Firmware name must contain a version (e.g. 1.0.0)
      </span>
      <div>3. Press Install and follow prompts</div>
    </div>

    <label class="file-upload" id="fileDrop">
      <input type="file" id="firmwareFile" accept=".bin" hidden>
      <span id="fileLabel">Select Firmware (.bin)</span>
      <div class="drag-text">Or drag and drop your file here</div>
    </label>

    <esp-web-install-button id="inst" manifest="data:application/json,{}" product="Orbiter" version="Detecting...">
      <button class="install-btn" slot="activate" disabled>Install Firmware</button>
    </esp-web-install-button>

    <div class="powered">
      Powered by
      <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>

      <div class="social-icons">
        <a href="https://docs.arsenal51.com" target="_blank" class="social-icon"><i class="fa-solid fa-book"></i></a>
        <a href="https://discord.gg/h2C8yjN47M" target="_blank" class="social-icon"><i class="fa-brands fa-discord"></i></a>
        <a href="https://arsenal51.com" target="_blank" class="social-icon"><i class="fa-solid fa-globe"></i></a>
      </div>
    </div>
  </div>

  <script>
  function initInstaller() {
    const unsupportedDiv = document.getElementById('unsupported');
    const installerDiv = document.getElementById('installer');
    const firmwareInput = document.getElementById('firmwareFile');
    const fileDrop = document.getElementById('fileDrop');
    const fileLabel = document.getElementById('fileLabel');
    const installBtn = document.querySelector('.install-btn');
    const installerButton = document.getElementById('inst');

    if (!('usb' in navigator)) {
      unsupportedDiv.hidden = false;
      return;
    }

    installerDiv.hidden = false;
    let oldManifestURL = null;

    async function handleFile(fileList) {
      if (!fileList || fileList.length === 0) return;

      const file = fileList[0];
      if (!file.name.endsWith('.bin')) {
        alert('Please select a valid .bin firmware file.');
        return;
      }

      const versionMatch = file.name.match(/(\d+\.\d+\.?\d*)/);
      if (!versionMatch) {
        alert('Error: Firmware name must contain a version number (e.g. 1.0.0).');
        fileLabel.textContent = "Select Firmware (.bin)";
        installBtn.disabled = true;
        return;
      }
      const detectedVersion = versionMatch[0];

      fileLabel.textContent = "Loading " + file.name;
      installBtn.disabled = true;

      try {
        const [bootRes, partRes] = await Promise.all([
          fetch('./bin/bootloader.bin'),
          fetch('./bin/partitions.bin')
        ]);

        if (!bootRes.ok || !partRes.ok) {
          throw new Error("Could not load /bin/bootloader.bin or /bin/partitions.bin from server.");
        }

        const bootBlob = await bootRes.blob();
        const partBlob = await partRes.blob();

        const bootURL = URL.createObjectURL(bootBlob);
        const partURL = URL.createObjectURL(partBlob);
        const firmwareURL = URL.createObjectURL(file);

        fileLabel.textContent = file.name;
        installerButton.files = fileList;

        const manifest = {
          name: "Orbiter Firmware",
          version: detectedVersion,
          improv_type: "ble_wifi", 
          home_assistant_domain: "a51orbiter",        // Better Wi-Fi detection
          erase_flash: true,
          builds: [
            {
              chipFamily: "ESP32",
              parts: [
                { path: bootURL, offset: 0x1000 },
                { path: partURL, offset: 0x8000 },
                { path: firmwareURL, offset: 0x10000 }
              ]
            }
          ]
        };

        const json = JSON.stringify(manifest);
        const blob = new Blob([json], { type: "application/json" });
        const blobURL = URL.createObjectURL(blob);

        if (oldManifestURL) URL.revokeObjectURL(oldManifestURL);
        oldManifestURL = blobURL;

        installerButton.setAttribute('version', detectedVersion);
        installerButton.setAttribute('manifest', blobURL);
        installerButton.manifest = blobURL;
        
        installBtn.disabled = false;

      } catch (err) {
        console.error(err);
        alert("Setup Error: " + err.message);
        fileLabel.textContent = "Select Firmware (.bin)";
      }
    }

    firmwareInput.addEventListener('change', () => handleFile(firmwareInput.files));
    fileDrop.addEventListener('dragover', (e) => { e.preventDefault(); fileDrop.classList.add('dragover'); });
    fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('dragover'));
    fileDrop.addEventListener('drop', (e) => {
      e.preventDefault();
      fileDrop.classList.remove('dragover');
      handleFile(e.dataTransfer.files);
    });

    // Custom complete logic to help with the Wi-Fi "Race Condition"
    installerButton.addEventListener('install-complete', () => { 
      setTimeout(() => {
        alert('Installation complete! If Wi-Fi setup does not appear, click "Next" or tap the Reset button on your Orbiter.');
      }, 1500);
    });

    installerButton.addEventListener('install-error', (e) => { 
      alert('Firmware installation failed: ' + e.detail.message); 
    });
  }
  </script>

</body>
</html>