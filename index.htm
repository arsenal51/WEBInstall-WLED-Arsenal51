<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Orbiter Update Installer</title>

  <link rel="icon" type="image/png" href="favicon.png">

  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        integrity="sha512-g9C6d0AqR7XzQ8Sh..." crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet" href="style.css">

  <script type="module"
    src="https://unpkg.com/esp-web-tools@10.1.0/dist/web/install-button.js?module"></script>
</head>

<body onload="initInstaller()">

  <div id="unsupported" class="card" hidden>
    <h2>Browser Not Supported</h2>
    <p>Please use Chrome or Edge on desktop.</p>
    <div class="browser-buttons">
      <button onclick="window.open('microsoft-edge:', '_blank')">Open Edge</button>
      <button onclick="window.open('https://www.google.com/chrome/', '_blank')">Download Chrome</button>
    </div>
  </div>

  <div id="installer" class="card" hidden>
    <img src="arsenal-logo.png" alt="Arsenal51 Logo" class="logo">

    <h1>UPDATE YOUR ORBITER</h1>
    <p class="subtitle">Flash firmware to your Orbiter</p>

    <div class="github-download">
      <p>Download firmware `.bin` files (optional):</p>
      <a href="https://github.com/arsenal51/WLED-Arsenal51/releases" target="_blank">
        View GitHub Releases
      </a>
    </div>

    <div class="steps">
      <div>1. Plug in your Orbiter device</div>
      <div>2. Select firmware file (.bin)</div>
      <div>3. Press Install and follow prompts</div>
    </div>

    <label class="file-upload" id="fileDrop">
      <input type="file" id="firmwareFile" accept=".bin" hidden>
      <span id="fileLabel">Select Firmware (.bin)</span>
      <div class="drag-text">Or drag and drop your file here</div>
    </label>

    <esp-web-install-button id="inst" manifest="data:application/json,{}">
      <button class="install-btn" slot="activate" disabled>Install Firmware</button>
    </esp-web-install-button>

    <div class="powered">
      Powered by
      <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>

      <div class="social-icons">
        <a href="https://docs.arsenal51.com" target="_blank" class="social-icon"><i class="fa-solid fa-book"></i></a>
        <a href="https://discord.gg/h2C8yjN47M" target="_blank" class="social-icon"><i class="fa-brands fa-discord"></i></a>
        <a href="https://arsenal51.com" target="_blank" class="social-icon"><i class="fa-solid fa-globe"></i></a>
      </div>
    </div>
  </div>

  <script>
  function initInstaller() {
    const unsupportedDiv = document.getElementById('unsupported');
    const installerDiv = document.getElementById('installer');
    const firmwareInput = document.getElementById('firmwareFile');
    const fileDrop = document.getElementById('fileDrop');
    const fileLabel = document.getElementById('fileLabel');
    const installBtn = document.querySelector('.install-btn');
    const installerButton = document.getElementById('inst');

    if (!('usb' in navigator)) {
      unsupportedDiv.hidden = false;
      return;
    }

    installerDiv.hidden = false;

    let oldManifestURL = null;
    let oldBinaryURL = null;

    function handleFile(fileList) {
      if (!fileList || fileList.length === 0) return;

      const file = fileList[0];
      if (!file.name.endsWith('.bin')) {
        alert('Please select a valid .bin firmware file.');
        return;
      }

      // Cleanup old Blob URLs from memory
      if (oldManifestURL) URL.revokeObjectURL(oldManifestURL);
      if (oldBinaryURL) URL.revokeObjectURL(oldBinaryURL);

      // Create a Blob URL for the actual BINARY file
      // This is the crucial fix for the "Invalid URL" error on the binary path
      const binaryBlobURL = URL.createObjectURL(file);
      oldBinaryURL = binaryBlobURL;

      // Update UI
      fileLabel.textContent = file.name;
      fileLabel.title = file.name;
      installBtn.disabled = false;

      // Pass the uploaded file to the ESP Web Tools input
      installerButton.files = fileList;

      // Generate manifest with the standard ESP32 App offset
      const manifest = {
        name: "Orbiter Firmware",
        version: "1.0.0",
        builds: [
          {
            chipFamily: "ESP32", // Double check if your Orbiter is ESP32-S2 or S3!
            parts: [
              { path: binaryBlobURL, offset: 0x10000 } // Changed from 0 to 0x10000
            ]
          }
        ]
      };

      // Convert manifest to its own Blob URL
      const json = JSON.stringify(manifest);
      const blob = new Blob([json], { type: "application/json" });
      const manifestURL = URL.createObjectURL(blob);
      oldManifestURL = manifestURL;

      // Assign to the component
      installerButton.setAttribute('manifest', manifestURL);
      installerButton.manifest = manifestURL;
    }

    // --- Listeners ---
    firmwareInput.addEventListener('change', () => handleFile(firmwareInput.files));

    fileDrop.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileDrop.classList.add('dragover');
    });

    fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('dragover'));

    fileDrop.addEventListener('drop', (e) => {
      e.preventDefault();
      fileDrop.classList.remove('dragover');
      handleFile(e.dataTransfer.files);
    });

    installerButton.addEventListener('install-complete', () => {
      alert('Installation complete!');
    });

    installerButton.addEventListener('install-error', (e) => {
      console.error("Install Error:", e.detail);
      alert('Firmware installation failed: ' + e.detail.message);
    });
  }
  </script>

</body>
</html>