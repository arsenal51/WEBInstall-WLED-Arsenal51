<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UPDATE YOUR ORBITER</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Barlow Bold -->
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@700&display=swap" rel="stylesheet">

  <!-- Font Awesome for Social Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" 
        integrity="sha512-g9C6d0AqR7XzQ8Sh..." crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- External CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- ESP Web Tools -->
  <script type="module"
    src="https://unpkg.com/esp-web-tools@10.1.0/dist/web/install-button.js?module"></script>
</head>

<body onload="initInstaller()">

  <div id="unsupported" class="card" hidden>
    <h2>Browser Not Supported</h2>
    <p>Please use Chrome or Edge on desktop.</p>
    <div class="browser-buttons">
      <button onclick="window.open('microsoft-edge:', '_blank')">Open Edge</button>
      <button onclick="window.open('https://www.google.com/chrome/', '_blank')">Download Chrome</button>
    </div>
  </div>

  <div id="installer" class="card" hidden>
    <!-- Logo -->
    <img src="arsenal-logo.png" alt="Arsenal51 Logo" class="logo">

    <h1>Arsenal51 Orbiter</h1>
    <p class="subtitle">Flash firmware to your ESP32</p>

    <!-- GitHub Firmware Downloads -->
    <div class="github-download">
      <p>Download firmware `.bin` files:</p>
      <a href="https://github.com/arsenal51/WLED-Arsenal51/releases" target="_blank">
        View GitHub Releases
      </a>
    </div>

    <div class="steps">
      <div>1. Plug in your ESP32</div>
      <div>2. Select firmware file</div>
      <div>3. Press Install</div>
    </div>

    <label class="file-upload" id="fileDrop">
      <input type="file" id="firmwareFile" accept=".bin" hidden>
      <span id="fileLabel">Select Firmware (.bin)</span>
      <div class="drag-text">Or drag and drop your file here</div>
    </label>

    <esp-web-install-button id="inst" manifest="">
      <button class="install-btn" slot="activate" disabled>Install Firmware</button>
    </esp-web-install-button>

    <div class="powered">
      Powered by
      <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>

      <!-- Social Icons -->
      <div class="social-icons">
        <a href="https://docs.arsenal51.com" target="_blank" class="social-icon"><i class="fa-solid fa-book"></i></a>
        <a href="https://discord.gg/h2C8yjN47M" target="_blank" class="social-icon"><i class="fa-brands fa-discord"></i></a>
        <a href="https://arsenal51.com" target="_blank" class="social-icon"><i class="fa-solid fa-globe"></i></a>
      </div>
    </div>
  </div>

  <script>
    function initInstaller() {
      const unsupportedDiv = document.getElementById('unsupported');
      const installerDiv = document.getElementById('installer');
      const firmwareInput = document.getElementById('firmwareFile');
      const installBtn = document.querySelector('.install-btn');
      const fileDrop = document.getElementById('fileDrop');
      const fileLabel = document.getElementById('fileLabel');
      let fileUrl = null;

      if (!('usb' in navigator)) {
        unsupportedDiv.hidden = false;
        return;
      }

      installerDiv.hidden = false;

      function handleFile(file) {
        if (!file || !file.name.endsWith('.bin')) {
          alert('Please select a valid .bin firmware file.');
          return;
        }

        if (fileUrl) URL.revokeObjectURL(fileUrl);
        fileUrl = URL.createObjectURL(file);

        const manifest = {
          name: "Arsenal51 Orbiter",
          board: "esp32",
          version: "user-upload",
          files: [{ name: file.name, url: fileUrl }]
        };

        document.getElementById('inst').manifest =
          'data:application/json;base64,' + btoa(JSON.stringify(manifest));

        installBtn.disabled = false;

        fileLabel.textContent = file.name;
        fileLabel.title = file.name;
      }

      firmwareInput.addEventListener('change', () => {
        const files = firmwareInput.files;
        if (!files || files.length === 0) return;
        handleFile(files[0]);
      });

      fileDrop.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileDrop.classList.add('dragover');
      });

      fileDrop.addEventListener('dragleave', () => {
        fileDrop.classList.remove('dragover');
      });

      fileDrop.addEventListener('drop', (e) => {
        e.preventDefault();
        fileDrop.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) handleFile(files[0]);
      });

      const installerButton = document.getElementById('inst');

      installerButton.addEventListener('install-complete', () => {
        if (fileUrl) URL.revokeObjectURL(fileUrl);
        alert('Installation complete!');
      });

      installerButton.addEventListener('install-error', (e) => {
        alert('Firmware installation failed: ' + e.detail.message);
      });

      installerButton.addEventListener('install-progress', (e) => {
        console.log(`Progress: ${(e.detail.progress * 100).toFixed(1)}%`);
      });
    }
  </script>

</body>
</html>
