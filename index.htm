<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta content='width=device-width' name='viewport'>
  <meta name="theme-color" content="#222222">
  <link rel="shortcut icon" href="favicon.png">
  <link rel="stylesheet" href="style.css">
  <title>Install Arsenal51 Orbiter</title>
  <script type="module" src="https://unpkg.com/esp-web-tools@10.1.0/dist/web/install-button.js?module"></script>
</head>

<body onload="initInstaller()">

  <div id="unsupported" hidden>
    <h2>Sorry, your browser is not supported!</h2>
    <p>Please use a Chromium-based browser (Chrome, Edge) with WebUSB enabled.</p>
  </div>

  <div class="main" id="installer" hidden>
    <h2>Install Arsenal51 Orbiter</h2>
    <ol>
      <li>Plug in your ESP32 to a USB port.</li>
      <li>Select the firmware version below.</li>
      <li>Hit "Install" to flash your board.</li>
    </ol>

    <label for="firmwareSelect">Select Version:</label>
    <select id="firmwareSelect" class="btn">
      <option value="">Loading latest releases...</option>
    </select>
    <br><br>

    <div class="container inst-button">
      <esp-web-install-button id="inst" manifest="">
        <button class="btn" slot="activate">Install</button>
      </esp-web-install-button>
    </div>
    <br>
    <span>Powered by </span>
    <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>
  </div>

  <script>
    async function initInstaller() {
      // WebUSB check for modern browsers
      if (!('usb' in navigator || 'USB' in window)) {
        document.getElementById('unsupported').hidden = false;
        return;
      }

      const installerDiv = document.getElementById('installer');
      installerDiv.hidden = false;

      const select = document.getElementById('firmwareSelect');
      const githubApi = 'https://api.github.com/repos/arsenal51/WLED-Arsenal51/releases';

      try {
        const response = await fetch(githubApi);
        if (!response.ok) throw new Error('Failed to fetch releases');
        const releases = await response.json();

        select.innerHTML = '';

        // Iterate releases and find .bin files
        releases.forEach(rel => {
          rel.assets.forEach(asset => {
            if (asset.name.endsWith('.bin')) {
              const option = document.createElement('option');
              option.value = asset.browser_download_url;
              option.textContent = asset.name.replace('ORBITER_', '');
              select.appendChild(option);
            }
          });
        });

        // Auto-select the first/latest version
        if (select.options.length > 0) {
          select.selectedIndex = 0;
          updateManifest(select.value);
        }

        // Update manifest on selection change
        select.addEventListener('change', () => {
          updateManifest(select.value);
        });

      } catch (e) {
        select.innerHTML = '<option value="">Failed to load releases</option>';
        console.error(e);
      }
    }

    function updateManifest(binUrl) {
      // Simple manifest for ESP Web Installer
      const manifest = {
        name: "Arsenal51 Orbiter",
        board: "esp32",
        version: "latest",
        files: [
          {
            name: binUrl.split('/').pop(),
            url: binUrl
          }
        ]
      };
      document.getElementById('inst').manifest = 'data:application/json;base64,' + btoa(JSON.stringify(manifest));
    }
  </script>

</body>
</html>
