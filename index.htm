<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta content='width=device-width' name='viewport'>
  <meta name="theme-color" content="#222222">
  <link rel="shortcut icon" href="favicon.png">
  <link rel="stylesheet" href="style.css">
  <title>Arsenal51 Orbiter Installer</title>
  <script type="module" src="https://unpkg.com/esp-web-tools@10.1.0/dist/web/install-button.js?module"></script>
</head>

<body onload="initInstaller()">

  <div class="main">
    <h2>Install Arsenal51 Orbiter Firmware</h2>
    <div id="unsupported" hidden>
      <p>Sorry, your browser is not supported. Please try on Desktop Chrome or Edge.</p>
    </div>

    <div id="installerContainer">
      <p>Select a release and hit Install:</p>
      <select id="releaseDropdown" class="btn"></select>

      <div class="container inst-button">
        <esp-web-install-button id="inst" manifest="">
          <button class="btn" slot="activate">Install Arsenal51 Orbiter</button>
        </esp-web-install-button>
      </div>
    </div>

    <br><br>
    <span>Powered by </span>
    <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>
  </div>

  <script>
    const owner = "arsenal51";
    const repo = "WLED-Arsenal51";
    const dropdown = document.getElementById("releaseDropdown");
    const installer = document.getElementById("inst");
    const unsupported = document.getElementById("unsupported");
    const installerContainer = document.getElementById("installerContainer");

    async function fetchReleases() {
      try {
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/releases`);
        const releases = await response.json();

        if (!Array.isArray(releases) || releases.length === 0) throw new Error("No releases found");

        dropdown.innerHTML = "";

        releases.forEach(release => {
          const orbiterBin = release.assets.find(asset =>
            /^ORBITER_\d+\.\d+\.\d+_ESP32\.bin$/.test(asset.name)
          );
          if (!orbiterBin) return;

          const option = document.createElement("option");
          option.value = orbiterBin.browser_download_url;
          option.textContent = release.name + " â†’ " + orbiterBin.name;
          dropdown.appendChild(option);
        });

        // Select latest release by default
        dropdown.selectedIndex = 0;
        setManifest();

      } catch (err) {
        console.error("Failed to fetch releases:", err);
        dropdown.innerHTML = "<option disabled>Failed to load releases</option>";
      }
    }

    function setManifest() {
      const binUrl = dropdown.value;
      if (!binUrl) return;

      const manifest = {
        "name": "Arsenal51 Orbiter",
        "version": dropdown.options[dropdown.selectedIndex].text,
        "parts": [{ "path": binUrl, "board": "esp32" }]
      };

      installer.manifest = manifest;
    }

    dropdown.addEventListener("change", setManifest);

    function initInstaller() {
      if (!checkSupported()) {
        unsupported.hidden = false;
        installerContainer.hidden = true;
      } else {
        unsupported.hidden = true;
        installerContainer.hidden = false;
        fetchReleases();
      }
    }
  </script>

</body>
</html>
