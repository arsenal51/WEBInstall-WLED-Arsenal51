<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta content='width=device-width' name='viewport'>
  <meta name="theme-color" content="#222222">
  <link rel="shortcut icon" href="favicon.png">
  <link rel="stylesheet" href="style.css">
  <title>Install Arsenal51 Orbiter</title>
  <script type="module" src="https://unpkg.com/esp-web-tools@10.1.0/dist/web/install-button.js?module"></script>
</head>

<body onload="initInstaller()">

  <div id="unsupported" hidden>
    <h2>Sorry, your browser is not supported!</h2>
    <p>Please use a Chromium-based browser (Chrome, Edge) with WebUSB enabled.</p>
  </div>

  <div class="main" id="installer" hidden>
    <h2>Install Arsenal51 Orbiter</h2>
    <ol>
      <li>Plug in your ESP32 to a USB port.</li>
      <li>Select your local firmware `.bin` file.</li>
      <li>Hit "Install" to flash your board.</li>
    </ol>

    <label for="firmwareFile">Select Firmware (.bin):</label>
    <input type="file" id="firmwareFile" accept=".bin" class="btn"><br><br>

    <div class="container inst-button">
      <esp-web-install-button id="inst" manifest="">
        <button class="btn" slot="activate">Install</button>
      </esp-web-install-button>
    </div>
    <br>
    <span>Powered by </span>
    <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>
  </div>

  <script>
    function initInstaller() {
      // WebUSB check
      if (!('usb' in navigator || 'USB' in window)) {
        document.getElementById('unsupported').hidden = false;
        return;
      }

      const installerDiv = document.getElementById('installer');
      installerDiv.hidden = false;

      const fileInput = document.getElementById('firmwareFile');
      const espButton = document.getElementById('inst');

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (!file) return;

        // Create a blob URL for the file
        const blobUrl = URL.createObjectURL(file);

        // Generate manifest for ESP Web Tools
        const manifest = {
          name: "Arsenal51 Orbiter",
          version: file.name.replace('.bin', ''),
          builds: [
            {
              chipFamily: "ESP32",
              parts: [
                {
                  path: blobUrl,
                  offset: 0
                }
              ]
            }
          ]
        };

        // Set manifest as base64 data URL
        espButton.manifest = 'data:application/json;base64,' + btoa(JSON.stringify(manifest));
      });
    }
  </script>

</body>
</html>
